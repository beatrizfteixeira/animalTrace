<!DOCTYPE html>
<html>

<head>
    <title>Mapa do Google</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        #map {
            height: 500px;
            margin-bottom: 20px;
        }
    </style>
    <script defer >
        var mapa
        var drawingManager
        var poligono = "";

        function initMap() {
            var map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: -21.227867, lng: -44.9811239 },
                zoom: 15,
            });
            const drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.POLYGON,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: [
                        google.maps.drawing.OverlayType.POLYGON,
                        google.maps.drawing.OverlayType.POLYLINE,
                        google.maps.drawing.OverlayType.CIRCLE,
                        google.maps.drawing.OverlayType.RECTANGLE,
                    ],
                },
                markerOptions: {
                    icon: "https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png",
                },
                circleOptions: {
                    fillColor: "#ffff00",
                    fillOpacity: 1,
                    strokeWeight: 5,
                    clickable: false,
                    editable: true,
                    zIndex: 1,
                },
            });

            drawingManager.setMap(map);
            mapa = map
            google.maps.event.addListener(drawingManager, "overlaycomplete", function (event) {
                if (event.type === google.maps.drawing.OverlayType.POLYGON) {
                    poligono = event.overlay.getPath().getArray()
                }
            });
        }

        function ativarDesenho() {
            drawingManager.setMap(mapa)
        }

        function salvarCoordenadas() {
            if (poligono != "") {
                var arrayCoordenadas = poligono.map(function(coord) {
                    return { latitude: coord.lat(), longitude: coord.lng() };
                });
                var jsonCoordenadas = JSON.stringify(arrayCoordenadas, null, 2);

                console.log(jsonCoordenadas);
                fetch('http://localhost:8000/coordenadas/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: jsonCoordenadas,
                }).then(response => response.json()).then(data => {
                    console.log('Resposta do servidor:', data);
                }).catch(error => {
                    console.error('Erro na solicitação:', error);
                });
            } else {
                alert('Desenhe um polígono primeiro.')
            }
        }

        function pesquisar() {
            var endereco = document.getElementById('endereco').value

            var geocoder = new google.maps.Geocoder()
            geocoder.geocode({ address: endereco }, function (results, status) {
                if (status === 'OK') {
                    var lat = results[0].geometry.location.lat();
                    var lng = results[0].geometry.location.lng();

                    var posicao = new google.maps.LatLng(lat, lng);
                    mapa.setCenter(posicao);
                    mapa.setZoom(14);
                    new google.maps.Marker({
                        position: posicao,
                        map: mapa,
                    });
                } else {
                    alert('Não foi possível encontrar o endereço.');
                }
            });
        }
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap&libraries=drawing"></script>
</head>

<body>
    <div class="container">
        <div class="row justify-content-center mt-5">
            <div class="col-md-6">
                <div class="input-group mb-3">
                    <input type="text" id="endereco" class="form-control" placeholder="Digite um endereço" />
                    <button onclick="pesquisar()" class="btn btn-primary">Pesquisar</button>
                </div>
            </div>
        </div>
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div id="map"></div>
            </div>
        </div>
        <div class="row justify-content-center">
            <div class="col-md-6">
                <button onclick="ativarDesenho()" class="btn btn-secondary me-2">Desenhar Polígono</button>
                <button onclick="salvarCoordenadas()" class="btn btn-primary">Salvar Coordenadas</button>
            </div>
        </div>
    </div>
</body>

</html>
